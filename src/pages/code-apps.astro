---
import Layout from "../layouts/Layout.astro";
---

<Layout
    title="CodeApps – PAC CLI Reference"
    description="Step-by-step Power Apps code app commands from the official Microsoft Learn quickstart. Click any command to copy."
>
    <div class="max-w-5xl mx-auto space-y-8">
        <!-- Hero -->
        <section class="text-center py-4">
            <div
                class="inline-block px-3 py-1 mb-4 text-[10px] font-mono font-bold tracking-[0.2em] text-purple-400 uppercase bg-purple-500/10 border border-purple-500/20 rounded-full"
            >
                Power Apps · Code Apps
            </div>
            <h1
                class="text-4xl md:text-5xl font-black text-white tracking-tighter mb-4"
            >
                CodeApps CLI Reference
            </h1>
            <p
                class="text-lg text-slate-400 max-w-2xl mx-auto font-medium leading-relaxed"
            >
                Official commands from
                <a
                    href="https://learn.microsoft.com/en-us/power-apps/developer/code-apps/how-to/create-an-app-from-scratch"
                    target="_blank"
                    rel="noopener"
                    class="text-purple-400 hover:text-purple-300 underline underline-offset-2 transition-colors"
                    >Microsoft Learn</a
                >. Click any command row to copy it.
            </p>
        </section>

        <!-- Approach switcher -->
        <div class="flex items-center justify-center gap-3 flex-wrap">
            <button
                id="tab-pac"
                class="tab-btn active-tab px-5 py-2 rounded-full text-sm font-semibold transition-all duration-150"
            >
                PAC CLI approach
            </button>
            <button
                id="tab-npm"
                class="tab-btn px-5 py-2 rounded-full text-sm font-semibold transition-all duration-150"
            >
                npm CLI approach <span
                    class="ml-1 text-[10px] font-mono uppercase bg-amber-500/20 text-amber-400 border border-amber-500/30 px-1.5 py-0.5 rounded-full"
                    >preview</span
                >
            </button>
        </div>

        <!-- PAC CLI workflow -->
        <div id="view-pac" class="space-y-6">
            <!-- notice -->
            <div
                class="flex gap-3 items-start glass p-4 rounded-xl border border-blue-500/20 text-sm text-slate-300 font-medium"
            >
                <svg
                    class="w-5 h-5 text-blue-400 shrink-0 mt-0.5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 110 20A10 10 0 0112 2z"
                    ></path>
                </svg>
                <span
                    >The <code class="text-blue-400 bg-blue-500/10 px-1 rounded"
                        >pac code</code
                    > commands will be deprecated in a future release. The new <strong
                        class="text-white">npm CLI</strong
                    > approach (see tab above) reduces prerequisites and replaces
                    them.</span
                >
            </div>

            <div id="pac-sections" class="space-y-6"></div>
        </div>

        <!-- npm CLI workflow -->
        <div id="view-npm" class="space-y-6 hidden">
            <div
                class="flex gap-3 items-start glass p-4 rounded-xl border border-amber-500/20 text-sm text-slate-300 font-medium"
            >
                <svg
                    class="w-5 h-5 text-amber-400 shrink-0 mt-0.5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 9v2m0 4h.01M12 2a10 10 0 110 20A10 10 0 0112 2z"
                    ></path>
                </svg>
                <span
                    >Available from <strong class="text-white"
                        >Power Apps SDK v1.0.4+</strong
                    >. No Power Platform CLI required – only Node.js and Git.
                    This is the recommended new approach.</span
                >
            </div>

            <div id="npm-sections" class="space-y-6"></div>
        </div>

        <!-- Toast -->
        <div
            id="toast"
            class="fixed bottom-6 right-6 z-50 opacity-0 transition-opacity duration-300 pointer-events-none"
        >
            <div
                class="flex items-center gap-2 bg-zinc-900 border border-purple-500/40 px-4 py-3 rounded-xl shadow-2xl text-sm text-slate-200"
            >
                <svg
                    class="w-4 h-4 text-purple-400 shrink-0"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M5 13l4 4L19 7"></path>
                </svg>
                <span id="toast-msg">Copied!</span>
            </div>
        </div>
    </div>
</Layout>

<script>
    // ─── Data ─────────────────────────────────────────────────────────────────

    interface Cmd {
        label: string;
        cmd: string;
        note?: string;
    }
    interface Section {
        step?: string;
        title: string;
        color: string;
        icon: string;
        commands: Cmd[];
    }

    const pacSections: Section[] = [
        {
            step: "00",
            title: "Prerequisites",
            color: "zinc",
            icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>`,
            commands: [
                {
                    label: "Check Node.js version (LTS required)",
                    cmd: "node --version",
                },
                { label: "Check PAC CLI version", cmd: "pac --version" },
                {
                    label: "Install / update PAC CLI via dotnet tool",
                    cmd: "dotnet tool install --global Microsoft.PowerApps.CLI.Tool",
                },
                {
                    label: "Update PAC CLI via dotnet tool",
                    cmd: "dotnet tool update --global Microsoft.PowerApps.CLI.Tool",
                },
            ],
        },
        {
            step: "01",
            title: "Step 1 – Initialize the project",
            color: "blue",
            icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>`,
            commands: [
                {
                    label: "Scaffold app from official Vite template",
                    cmd: "npx degit github:microsoft/PowerAppsCodeApps/templates/vite my-app",
                    note: "Creates a new folder called my-app",
                },
                { label: "Navigate into the app folder", cmd: "cd my-app" },
            ],
        },
        {
            step: "02",
            title: "Step 2 – Authenticate & select environment",
            color: "purple",
            icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>`,
            commands: [
                {
                    label: "Authenticate PAC CLI (interactive browser login)",
                    cmd: "pac auth create",
                    note: "Sign in with your Power Platform / Microsoft Entra account when prompted",
                },
                {
                    label: "Select your target environment",
                    cmd: "pac env select --environment <Your environment ID>",
                    note: "Replace <Your environment ID> with the GUID or URL of your environment",
                },
                { label: "Verify active environment", cmd: "pac env who" },
                {
                    label: "List all available environments",
                    cmd: "pac env list",
                },
            ],
        },
        {
            step: "03",
            title: "Step 3 – Install SDK & init code app",
            color: "cyan",
            icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>`,
            commands: [
                {
                    label: "Install project dependencies (Power Apps SDK included)",
                    cmd: "npm install",
                },
                {
                    label: "Initialize code app (PAC CLI)",
                    cmd: 'pac code init --displayname "App From Scratch"',
                    note: "Creates the code app manifest in your environment",
                },
            ],
        },
        {
            step: "04",
            title: "Step 4 – Run locally",
            color: "green",
            icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>`,
            commands: [
                {
                    label: "Start local dev server",
                    cmd: "npm run dev",
                    note: "Open the URL labelled 'Local Play' in the same browser profile as your tenant",
                },
            ],
        },
        {
            step: "05",
            title: "Step 5 – Build & deploy to Power Apps",
            color: "orange",
            icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>`,
            commands: [
                {
                    label: "Build TypeScript + Vite, then push to environment",
                    cmd: "npm run build | pac code push",
                    note: "Returns a Power Apps URL on success",
                },
                {
                    label: "Build only (tsc + vite)",
                    cmd: "npm run build",
                },
                {
                    label: "Push to Power Apps (publish new version)",
                    cmd: "pac code push",
                    note: "Upload already-built dist/ files to your environment",
                },
            ],
        },
    ];

    const npmSections: Section[] = [
        {
            step: "00",
            title: "Prerequisites",
            color: "zinc",
            icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>`,
            commands: [
                {
                    label: "Check Node.js version (LTS required)",
                    cmd: "node --version",
                },
                {
                    label: "No Power Platform CLI needed – only Node.js + Git",
                    cmd: "git --version",
                    note: "Power Platform CLI is NOT required for the npm CLI approach",
                },
            ],
        },
        {
            step: "01",
            title: "Step 1 – Initialize the project",
            color: "blue",
            icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>`,
            commands: [
                {
                    label: "Scaffold app from official Vite template",
                    cmd: "npx degit github:microsoft/PowerAppsCodeApps/templates/vite my-app",
                    note: "Creates a new folder called my-app",
                },
                { label: "Navigate into the app folder", cmd: "cd my-app" },
            ],
        },
        {
            step: "02",
            title: "Step 2 – Install dependencies & init code app",
            color: "purple",
            icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>`,
            commands: [
                { label: "Install project dependencies", cmd: "npm install" },
                {
                    label: "Install Power Apps SDK (v1.0.4+ for npm CLI)",
                    cmd: "npm install @microsoft/power-apps",
                },
                {
                    label: "Init code app – interactive mode (prompts you for details)",
                    cmd: "npx power-apps init",
                    note: "The CLI authenticates you automatically via browser login",
                },
                {
                    label: "Init code app – pass options directly",
                    cmd: 'npx power-apps init --displayName "App From Scratch" --environmentId <Your environment ID>',
                    note: "Replace <Your environment ID> with your environment GUID",
                },
            ],
        },
        {
            step: "03",
            title: "Step 3 – Test locally",
            color: "green",
            icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>`,
            commands: [
                {
                    label: "Run code app locally (dev server)",
                    cmd: "npx power-apps run",
                    note: "Open the 'Local Play' URL in the same browser profile as your tenant",
                },
            ],
        },
        {
            step: "04",
            title: "Step 4 – Build & deploy to Power Apps",
            color: "orange",
            icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>`,
            commands: [
                {
                    label: "Build TypeScript + Vite (runs tsc -b && vite build)",
                    cmd: "npm run build",
                },
                {
                    label: "Push built app to Power Apps environment",
                    cmd: "npx power-apps push",
                    note: "Returns a Power Apps URL on success",
                },
                {
                    label: "Build and push in one step",
                    cmd: "npm run build && npx power-apps push",
                },
            ],
        },
    ];

    // ─── Color Tokens ─────────────────────────────────────────────────────────
    type ColorKey =
        | "blue"
        | "purple"
        | "cyan"
        | "green"
        | "orange"
        | "zinc"
        | "teal";
    const colors: Record<
        ColorKey,
        { border: string; icon: string; hover: string; step: string }
    > = {
        blue: {
            border: "border-blue-500",
            icon: "text-blue-400",
            hover: "hover:border-blue-500/40",
            step: "text-blue-400",
        },
        purple: {
            border: "border-purple-500",
            icon: "text-purple-400",
            hover: "hover:border-purple-500/40",
            step: "text-purple-400",
        },
        cyan: {
            border: "border-cyan-500",
            icon: "text-cyan-400",
            hover: "hover:border-cyan-500/40",
            step: "text-cyan-400",
        },
        green: {
            border: "border-green-500",
            icon: "text-green-400",
            hover: "hover:border-green-500/40",
            step: "text-green-400",
        },
        orange: {
            border: "border-orange-500",
            icon: "text-orange-400",
            hover: "hover:border-orange-500/40",
            step: "text-orange-400",
        },
        zinc: {
            border: "border-zinc-600",
            icon: "text-zinc-400",
            hover: "hover:border-zinc-600/40",
            step: "text-zinc-400",
        },
        teal: {
            border: "border-teal-500",
            icon: "text-teal-400",
            hover: "hover:border-teal-500/40",
            step: "text-teal-400",
        },
    };

    // ─── Render ───────────────────────────────────────────────────────────────
    function renderSections(sections: Section[], containerId: string) {
        const container = document.getElementById(containerId)!;
        sections.forEach((section) => {
            const c = colors[section.color as ColorKey] ?? colors.zinc;
            const card = document.createElement("div");
            card.className = `glass p-6 rounded-2xl border-l-4 ${c.border} shadow-xl`;
            card.innerHTML = `
        <h2 class="text-lg font-bold text-white mb-5 flex items-center gap-3">
          ${section.step ? `<span class="text-2xl font-black ${c.step} opacity-30 leading-none w-8 shrink-0">${section.step}</span>` : ""}
          <svg class="w-5 h-5 ${c.icon} shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">${section.icon}</svg>
          ${section.title}
        </h2>
        <div class="space-y-2">
          ${section.commands
              .map(
                  (item) => `
            <button
              data-cmd="${item.cmd.replace(/"/g, "&quot;")}"
              class="cmd-btn w-full group flex items-start gap-3 text-left rounded-xl border border-white/5 px-4 py-3 transition-all duration-150 ${c.hover} hover:bg-white/5 active:scale-[0.99]"
            >
              <div class="flex-1 min-w-0 space-y-0.5">
                <div class="text-[11px] text-slate-400 font-mono truncate">${item.label}</div>
                <div class="font-mono text-sm text-slate-100 break-all">${item.cmd}</div>
                ${item.note ? `<div class="text-[11px] text-slate-500 italic mt-1">${item.note}</div>` : ""}
              </div>
              <svg class="w-4 h-4 text-zinc-600 group-hover:text-slate-400 shrink-0 mt-1 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
            </button>
          `,
              )
              .join("")}
        </div>
      `;
            container.appendChild(card);
        });
    }

    renderSections(pacSections, "pac-sections");
    renderSections(npmSections, "npm-sections");

    // ─── Tab Switcher ─────────────────────────────────────────────────────────
    const tabPac = document.getElementById("tab-pac")!;
    const tabNpm = document.getElementById("tab-npm")!;
    const viewPac = document.getElementById("view-pac")!;
    const viewNpm = document.getElementById("view-npm")!;

    function setTab(active: "pac" | "npm") {
        const isP = active === "pac";
        viewPac.classList.toggle("hidden", !isP);
        viewNpm.classList.toggle("hidden", isP);
        tabPac.classList.toggle("active-tab", isP);
        tabNpm.classList.toggle("active-tab", !isP);
    }

    tabPac.addEventListener("click", () => setTab("pac"));
    tabNpm.addEventListener("click", () => setTab("npm"));

    // ─── Copy ─────────────────────────────────────────────────────────────────
    const toast = document.getElementById("toast")!;
    const toastMsg = document.getElementById("toast-msg")!;
    let toastTimer: ReturnType<typeof setTimeout>;

    function showToast(cmd: string) {
        toastMsg.textContent = `Copied: ${cmd.length > 50 ? cmd.slice(0, 50) + "…" : cmd}`;
        toast.classList.remove("opacity-0");
        toast.classList.add("opacity-100");
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
            toast.classList.remove("opacity-100");
            toast.classList.add("opacity-0");
        }, 2400);
    }

    document.addEventListener("click", async (e) => {
        const btn = (e.target as Element).closest<HTMLElement>(".cmd-btn");
        if (!btn) return;
        const cmd = btn.dataset.cmd ?? "";
        try {
            await navigator.clipboard.writeText(cmd);
        } catch {
            const ta = document.createElement("textarea");
            ta.value = cmd;
            ta.style.cssText = "position:fixed;opacity:0";
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
        }
        showToast(cmd);
    });
</script>

<style>
    .tab-btn {
        background: rgba(255, 255, 255, 0.05);
        color: #94a3b8;
        border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .tab-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        color: #e2e8f0;
    }
    .active-tab {
        background: rgba(168, 85, 247, 0.15);
        color: #c084fc;
        border-color: rgba(168, 85, 247, 0.35);
    }
</style>
