import("https://esm.sh/plotly.js-dist-min@2.35.2").then(async ({ default: Plotly }) => {
  const chartDiv = document.getElementById("plotly-chart");
  chartDiv.style.justifyContent = "center";
  chartDiv.style.alignItems = "center";

  // ---------------------------
  // ðŸ”¹ Dane z Grafany
  // ---------------------------
  // context.data zawiera wyniki zapytania SQL
  const allData = context.data[0];

  if (!allData || allData.length === 0) {
    chartDiv.innerHTML = "<b>Brak danych</b>";
    return;
  }

  // Konwersja danych na tablicÄ™ obiektÃ³w {Customer, Supplier, Maker, Value}
  const salesData = allData.map((row) => ({
    customer: row.Customer,
    supplier: row.Supplier,
    maker: row.Maker,
    value: Number(row.Value) || 0,
  }));

  // ---------------------------
  // ðŸ”¹ Agregacja wartoÅ›ci
  // ---------------------------
  const customers = {};
  let totalSales = 0;

  salesData.forEach(({ customer, supplier, maker, value }) => {
    totalSales += value;
    if (!customers[customer]) customers[customer] = { total: 0, suppliers: {} };
    customers[customer].total += value;

    if (!customers[customer].suppliers[supplier])
      customers[customer].suppliers[supplier] = { total: 0, makers: {} };
    customers[customer].suppliers[supplier].total += value;

    if (!customers[customer].suppliers[supplier].makers[maker])
      customers[customer].suppliers[supplier].makers[maker] = 0;
    customers[customer].suppliers[supplier].makers[maker] += value;
  });

  // ---------------------------
  // ðŸ”¹ Tworzenie struktury Sunburst
  // ---------------------------
  const ids = [];
  const labels = [];
  const parents = [];
  const values = [];
  const percentages = [];

  // root
  ids.push("root");
  labels.push(totalSales.toFixed(0));
  parents.push("");
  values.push(totalSales);
  percentages.push(100);

  Object.entries(customers).forEach(([cust, cdata]) => {
    const custId = `cust::${cust}`;
    ids.push(custId);
    labels.push(cust);
    parents.push("root");
    values.push(cdata.total);
    percentages.push(Number(((cdata.total / totalSales) * 100).toFixed(1)));

    Object.entries(cdata.suppliers).forEach(([supp, sdata]) => {
      const suppId = `cust::${cust}||supp::${supp}`;
      ids.push(suppId);
      labels.push(supp);
      parents.push(custId);
      values.push(sdata.total);
      percentages.push(Number(((sdata.total / totalSales) * 100).toFixed(1)));

      Object.entries(sdata.makers).forEach(([maker, val]) => {
        const makerId = `cust::${cust}||supp::${supp}||maker::${maker}`;
        ids.push(makerId);
        labels.push(maker);
        parents.push(suppId);
        values.push(val);
        percentages.push(Number(((val / totalSales) * 100).toFixed(2)));
      });
    });
  });

  // ---------------------------
  // ðŸ”¹ Tworzenie wykresu
  // ---------------------------
  const plotData = [
    {
      type: "sunburst",
      ids,
      labels,
      parents,
      values,
      branchvalues: "total",
      insidetextorientation: "radial",
      customdata: percentages,
      hovertemplate:
        "<b>%{label}</b><br>" +
        "Sales: %{value:,.0f} PLN<br>" +
        "Share: %{customdata}%<extra></extra>",
    },
  ];

  const layout = {
    title: { text: "2025 Sales Breakdown by Customer / Supplier / Maker", x: 0.5, font: { color: "white" } },
    margin: { l: 0, r: 0, b: 0, t: 40 },
    //sunburstcolorway: ["#636efa", "#ef553b", "#00cc96", "#ab63fa", "#ffa15a"],
    outsidetextfont: { size: 20, color: "#377eb8" },
    paper_bgcolor: "rgba(0,0,0,0)",
    plot_bgcolor: "rgba(0,0,0,0)",
    // insidetextorientation: 'radial',
    // textposition: 'outside',
    extendsunburstcolorway: true,
    outsidetextfont: { size: 20, color: "#377eb8" },
  };

  const config = { displayModeBar: false, responsive: false };

  function draw() {
    const rect = chartDiv.getBoundingClientRect();
    const layoutSized = Object.assign({}, layout, {
      width: Math.max(Math.floor(rect.width), 120),
      height: Math.max(Math.floor(rect.height), 120),
    });
    Plotly.react(chartDiv, plotData, layoutSized, config);
  }

  draw();

  if (typeof ResizeObserver !== "undefined") {
    new ResizeObserver(draw).observe(chartDiv);
  } else {
    window.addEventListener("resize", draw);
  }
});